
module.exports = function(serviceLocator) {
  var authService = serviceLocator.get('authService');
  var db = serviceLocator.get('db');
  var app = serviceLocator.get('app');

  var tokensDb = db.sublevel('tokens');

  var oldLogin = authService.login;
  authService.login = function(username, password, callback) {
    oldLogin(username, password, function(err, token) {
      if(err) return callback(err);
      
      tokensDb.put(token, {username: username}, function() {
        callback(null, token);
      });
    });
  };

  var oldCheckToken = authService.checkToken;
  authService.checkToken = function(token, callback) {
    tokensDb.get(token, function(err, res) {
      if(err) return callback(err);
      
      oldCheckToken(token, callback);
    });
  };

  authService.logout = function(token, callback) {
    tokensDb.del(token, callback);
  };

  app.get('/logout', function (req, res, next) {
    authService.logout(req.query.token, function() {
      res.status(200).send({ok: true});
    });
  });
};


